config:
  environments:
    local:
      target: http://localhost:3000
    production:
      target: https://dev.makevalue.net/prod
  # target: http://localhost:3000
  processor: './processor.js' # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•  ì™¸ë¶€ JS íŒŒì¼
  # target: http://localhost:3000
  phases: # í…ŒìŠ¤íŠ¸ ë™ì•ˆì˜ ë¶€í•˜ í”„ë¡œíŒŒì¼ (í…ŒìŠ¤íŠ¸ ìš”ì²­ ì‹œê°„ê³¼ ë¹„ìœ¨ì„ ì˜ë¯¸)
    # 5ì´ˆ ë™ì•ˆ ì´ˆë‹¹ 1ëª…ì˜ ì‚¬ìš©ìê°€ ìš”ì²­
    - duration: 5
      arrivalRate: 1
      name: Warm up phase
  payload:
    path: './accounts.csv'
    fields:
      - 'email'
      - 'password'
    order: sequence # ë°ì´í„°ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ í• ë‹¹
  apdex:
    threshold: 100
  ensure:
    thresholds:
      - http.response_time.p99: 100
      - http.response_time.p95: 75

# beforeì€ í•œ ë²ˆë§Œ ìˆ˜í–‰ë¨. ì¦‰ ì—¬ê¸°ì„œ ì„¤ì •ëœ í† í° ë³€ìˆ˜ëŠ” íŠ¹ì • vuserì˜ tokenì´ ì•„ë‹ˆë¼ ì „ì²´ vuserë“¤ì—ê²Œ ì ìš©ë¨
# https://github.com/artilleryio/artillery/issues/842#issuecomment-765496311

# ì—¬ëŸ¬ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì •ì˜ - ì´ ê²½ìš° ì‚¬ìš©ì í”„ë¡œí•„ì„ ì¡°íšŒí•˜ëŠ” ë‹¨ì¼ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì¡´ì¬
scenarios:
  - beforeScenario: 'bsLogin'
    afterScenario: 'asLogout'
    flow:
      # Home Page Enter Requests
      - log: '[{{ email }}] Enter home page ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸'
      - get: # GET profile apië¥¼ í˜¸ì¶œí•´ì„œ organizationIdë¥¼ ê°€ì ¸ì™€ì•¼ GET organizations/{organizaionId} APIë¥¼ í˜¸ì¶œ ê°€ëŠ¥ - ì¦‰ ê°™ì€ Parallelë¡œ ë¬¶ì„ ìˆ˜ ì—†ìŒ
          url: '/users/profile'
          headers:
            authorization: 'Bearer {{ token }}'
          capture:
            - json: $.organizationId
              as: organizationId
          beforeRequest:
            - 'brLog'
            # - 'brUpdateTokenIfTokenExpired'
          afterResponse: 'arLog'
      - parallel:
          - get:
              url: '/organizations/{{ organizationId }}'
              headers:
                authorization: 'Bearer {{ token }}'
              # capture:
              #   - json: $
              #     as: organization
              beforeRequest:
                - 'brLog'
                # - 'brUpdateTokenIfTokenExpired'
              afterResponse: 'arLog'
          - get:
              url: '/users/hands/status'
              headers:
                authorization: 'Bearer {{ token }}'
              beforeRequest:
                - 'brLog'
                # - 'brUpdateTokenIfTokenExpired'
              afterResponse: 'arLog'
          - get:
              url: '/assigning-task-alerts'
              qs:
                limit: 9007199254740991
              headers:
                authorization: 'Bearer {{ token }}'
              beforeRequest:
                - 'brLog'
                # - 'brUpdateTokenIfTokenExpired'
              afterResponse: 'arLog'
          - loop:
              - get:
                  url: '/jobs'
                  qs:
                    page: 1
                    limit: 100
                    jobStatus: '{{ $loopElement }}'
                  headers:
                    authorization: 'Bearer {{ token }}'
                  beforeRequest:
                    - 'brLog'
                    # - 'brUpdateTokenIfTokenExpired'
                  afterResponse: 'arLog'
            over:
              - 'Not Started'
              - 'In Progress'
              - 'Completed'
              - 'Sent To Client'
              - 'On Hold'
              - 'Canceled'
              - 'Canceled (Invoice)'
          - get:
              url: '/jobs'
              qs:
                page: 1
                limit: 100
              headers:
                authorization: 'Bearer {{ token }}'
              beforeRequest:
                - 'brLog'
                # - 'brUpdateTokenIfTokenExpired'
              afterResponse:
                - 'arLog'
                - 'arVariableizeInProgressJob'
              capture:
                - json: $
                  as: 'jobs'
      - log: '[{{ email }}] Job detail Page Entering Looping ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸ğŸ–ï¸'
      # - function: 'fnPrintVars'
      - loop:
          - log: '[{{ email }}] Job detail Page Enter {{ $loopCount }} {{ jobs.items[{{$loopCount}}].id }} ğŸ–ï¸'
          - get:
              url: '/jobs/{{ jobs.items[{{$loopCount}}].id }}'
              headers:
                authorization: 'Bearer {{ token }}'
              # capture:
              #   - json: $
              #     as: jobDetail
              beforeRequest:
                - 'brLog'
                # - 'brUpdateTokenIfTokenExpired'
              afterResponse:
                - 'arLog'
                - 'arSetAssigneeIdsInJobDetailPage'
          - parallel:
              - get:
                  url: '/ordered-job-notes/{{ jobs.items[{{$loopCount}}].id }}'
                  headers:
                    authorization: 'Bearer {{ token }}'
                  beforeRequest:
                    - 'brLog'
                    # - 'brUpdateTokenIfTokenExpired'
                  afterResponse: 'arLog'
              - get:
                  ifTrue: '{{ jobs.items[{{$loopCount}}].projectId }}'
                  url: '/projects/{{ jobs.items[{{$loopCount}}].projectId }}'
                  headers:
                    authorization: 'Bearer {{ token }}'
                  # capture:
                  #   - json: $
                  #     as: projectDetail
                  beforeRequest:
                    - 'brLog'
                    # - 'brUpdateTokenIfTokenExpired'
                  afterResponse: 'arLog'
              - get:
                  url: '/utilities'
                  headers:
                    authorization: 'Bearer {{ token }}'
                  qs:
                    limit: 9007199254740991
                    stateAbbreviation: 'AZ'
                  beforeRequest:
                    - 'brLog'
                    # - 'brUpdateTokenIfTokenExpired'
                  afterResponse: 'arLog'
              - loop:
                  - get:
                      url: '/users'
                      qs:
                        organizationId: 'jobs.items[{{$loopCount}}].clientInfo.clientOrganizationId'
                      limit: 9007199254740991
                      status: '{{ $loopElement }}'
                      beforeRequest:
                        - 'brLog'
                        # - 'brUpdateTokenIfTokenExpired'
                      afterResponse: 'arLog'
                over:
                  - 'Active'
                  - 'Invitation Sent'
                  - 'Invitation Not Sent'
              - loop:
                  - get:
                      url: '/assigned-tasks/{{ $loopElement }}/available-workers'
                      headers:
                        authorization: 'Bearer {{ token }}'
                      beforeRequest:
                        - 'brLog'
                        # - 'brUpdateTokenIfTokenExpired'
                      afterResponse: 'arLog'
                over: assigneeIds
        count: '{{ jobs.totalCount }}'
